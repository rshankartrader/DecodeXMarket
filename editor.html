<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DecodeXMarket - Tomorrow Market Overview</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== CSS RESET & VARIABLES ===== */
        :root {
            --primary: #10b981;
            --secondary: #059669;
            --accent: #f43f5e;
            --warning: #f39c12;
            --dark: #0f172a;
            --darker: #0a1120;
            --light: #ecf0f1;
            --gray: #94a3b8;
            --border: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        /* ===== COMPACT 9:16 RECTANGLE BOX ===== */
        .rectangle-box {
            width: 337.5px; /* 9 units */
            height: 600px; /* 16 units */
            background: linear-gradient(145deg, #0d1525, #111a2d);
            border-radius: 18px;
            border: 3px solid var(--primary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Reduced from 12px */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        /* Compact Header */
        .box-header {
            text-align: center;
            padding-bottom: 10px; /* Reduced from 12px */
            border-bottom: 2px solid var(--primary);
            margin-bottom: 4px; /* Reduced from 5px */
        }

        .box-header h1 {
            color: white;
            font-size: 18px;
            font-weight: 900;
            letter-spacing: -0.3px;
            margin-bottom: 3px; /* Reduced from 4px */
            line-height: 1.2;
        }

        .box-date {
            color: var(--gray);
            font-size: 11px; /* Reduced from 12px */
            font-weight: 600;
        }

        /* Compact Content Sections */
        .section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 9px; /* Reduced from 10px */
            padding: 10px; /* Reduced from 12px */
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            flex-shrink: 0;
        }

        .section-title {
            color: var(--primary);
            font-size: 12px; /* Reduced from 13px */
            font-weight: 800;
            margin-bottom: 8px; /* Reduced from 10px */
            display: flex;
            align-items: center;
            gap: 5px; /* Reduced from 6px */
        }

        .section-title i {
            font-size: 13px; /* Reduced from 14px */
        }

        /* Expected Move - Compact */
        .prediction-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 8px 10px; /* Reduced from 10px 12px */
            min-height: 60px; /* Reduced from 65px */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #finalPrediction {
            font-size: 19px; /* Reduced from 20px */
            font-weight: 900;
            color: white;
            text-align: center;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            line-height: 1.2;
            min-height: 26px; /* Reduced from 28px */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Support & Resistance - Ultra Compact Horizontal */
        .levels-section {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Reduced from 10px */
            margin-top: 4px; /* Reduced from 5px */
        }

        .levels-row {
            display: flex;
            align-items: center;
            gap: 6px; /* Reduced from 8px */
            margin-bottom: 1px; /* Reduced from 2px */
        }

        .level-label {
            min-width: 65px; /* Reduced from 70px */
            font-size: 11px; /* Reduced from 12px */
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 3px; /* Reduced from 4px */
        }

        .resistance-label {
            color: var(--accent);
        }

        .support-label {
            color: var(--primary);
        }

        .levels-container {
            flex: 1;
            display: flex;
            gap: 5px; /* Reduced from 6px */
            flex-wrap: wrap;
        }

        .level-value {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 6px; /* Reduced from 5px 8px */
            border-radius: 5px; /* Reduced from 6px */
            font-size: 11px; /* Reduced from 12px */
            font-weight: 700;
            min-width: 55px; /* Reduced from 58px */
            text-align: center;
            border: 1px solid;
            flex-shrink: 0;
        }

        .resistance-value {
            border-color: rgba(244, 63, 94, 0.3);
            color: #ff6b8b;
        }

        .support-value {
            border-color: rgba(16, 185, 129, 0.3);
            color: #34d399;
        }

        /* Expected Reversal Times - ULTRA COMPACT */
        .reversal-section {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.15) 0%, rgba(231, 76, 60, 0.15) 100%);
            border: 1px solid rgba(243, 156, 18, 0.3);
            padding: 7px 9px; /* Reduced from 8px 10px */
            min-height: 80px; /* Reduced from 85px */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .reversal-times {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px; /* Reduced from 6px */
            margin-top: 1px; /* Reduced from 2px */
        }

        .time-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px; /* Reduced from 5px */
            padding: 5px; /* Reduced from 6px */
            text-align: center;
            border: 1px solid rgba(243, 156, 18, 0.2);
            min-height: 35px; /* Reduced from 38px */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .time-bar {
            font-size: 8px; /* Reduced from 9px */
            color: var(--warning);
            margin-bottom: 1px; /* Reduced from 2px */
            font-weight: 600;
        }

        .time-value {
            font-size: 10px; /* Reduced from 11px */
            font-weight: 800;
            color: white;
            line-height: 1.2;
        }

        /* Contact Information - Semi Transparent Brand Labels */
        .contact-info {
            background: rgba(148, 163, 184, 0.1); /* 60% opacity gray */
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
            backdrop-filter: blur(4px);
        }

        .contact-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .contact-icon {
            color: var(--primary);
            font-size: 11px;
            width: 16px;
            text-align: center;
        }

        .contact-text {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .instagram-text {
            color: #E4405F; /* Instagram pink color */
        }

        .whatsapp-text {
            color: #4ADE80; /* WhatsApp bright green color */
        }

        /* Disclaimer - Fits perfectly at bottom */
        .disclaimer-box {
            margin-top: auto;
            padding: 7px 9px; /* Reduced from 8px 10px */
            background: rgba(244, 63, 94, 0.1);
            border: 1px solid rgba(244, 63, 94, 0.3);
            border-radius: 5px; /* Reduced from 6px */
            font-size: 7.5px; /* Reduced from 8px */
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            line-height: 1.2;
            flex-shrink: 0;
        }

        .disclaimer-box strong {
            color: var(--accent);
            font-size: 8px; /* Reduced from 8.5px */
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
            flex-shrink: 0;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .control-btn.secondary {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        }

        .control-btn.slides {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        /* Loading */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--primary);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-weight: 600;
            font-size: 13px;
            max-width: 300px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Slides Processing Modal */
        .slides-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .slides-modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 3px solid var(--primary);
            text-align: center;
        }

        .slides-status {
            color: white;
            font-size: 18px;
            margin: 20px 0;
            font-weight: 600;
        }

        .slides-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 20px auto;
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .rectangle-box {
                width: 90vw;
                height: 160vw; /* Maintain 9:16 aspect ratio */
                padding: 15px;
            }
            
            .box-header h1 {
                font-size: 16px;
            }
            
            #finalPrediction {
                font-size: 18px;
            }
            
            .level-value {
                min-width: 52px;
                font-size: 11px;
                padding: 4px 6px;
            }
            
            .time-item {
                padding: 5px;
                min-height: 35px;
            }
            
            .controls {
                flex-direction: column;
                width: 90vw;
            }
            
            .control-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: var(--primary); text-align: center; margin-bottom: 5px; font-size: 20px;">
            <i class="fas fa-chart-line"></i> Market Overview & Reel Slides Generator
        </h1>
        <p style="color: var(--gray); text-align: center; margin-bottom: 15px; font-size: 12px;">
            9:16 Instagram Format â€¢ All Data in One View â€¢ 6-Reel Slides Export
        </p>

        <!-- 9:16 Rectangle Box -->
        <div class="rectangle-box" id="overviewBox">
            <!-- Header -->
            <div class="box-header">
                <h1>Tomorrow Market Overview</h1>
                <div class="box-date" id="currentDate">Loading...</div>
            </div>

            <!-- Expected Move -->
            <div class="section prediction-box">
                <div class="section-title">
                    <i class="fas fa-bullhorn"></i> Expected Move
                </div>
                <div id="finalPrediction">Loading prediction...</div>
            </div>

            <!-- Support & Resistance -->
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-layer-group"></i> Support & Resistance
                </div>
                <div class="levels-section">
                    <!-- Resistance -->
                    <div class="levels-row">
                        <div class="level-label resistance-label">
                            <i class="fas fa-arrow-up"></i> R:
                        </div>
                        <div class="levels-container" id="resistanceLevels">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Support -->
                    <div class="levels-row">
                        <div class="level-label support-label">
                            <i class="fas fa-arrow-down"></i> S:
                        </div>
                        <div class="levels-container" id="supportLevels">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expected Reversal Times - ULTRA COMPACT -->
            <div class="section reversal-section">
                <div class="section-title">
                    <i class="fas fa-retweet"></i> Expected Reversal @15min
                </div>
                <div class="reversal-times" id="reversalTimes">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <!-- Contact Information - Semi Transparent -->
            <div class="contact-info">
                <div class="contact-row">
                    <div class="contact-icon">
                        <i class="fab fa-instagram"></i>
                    </div>
                    <div class="contact-text instagram-text">
                        @DecodeXMarket
                    </div>
                </div>
                <div class="contact-row">
                    <div class="contact-icon">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <div class="contact-text whatsapp-text">
                        WhatsApp: 8271890090
                    </div>
                </div>
            </div>

            <!-- Disclaimer - Now fits perfectly -->
            <div class="disclaimer-box">
                <strong>Disclaimer:</strong> I am not SEBI registered, provided info is only for educational purposes and don't consider it as buy or sell signal.
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="control-btn" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="control-btn" onclick="exportAsImage()">
                <i class="fas fa-download"></i> Export Image
            </button>
            <button class="control-btn slides" onclick="generateReelSlides()">
                <i class="fas fa-film"></i> Generate 6 Reel Slides
            </button>
            <button class="control-btn secondary" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i> Dashboard
            </button>
        </div>

        <p style="color: var(--gray); text-align: center; margin-top: 10px; font-size: 11px;">
            <i class="fas fa-info-circle"></i> Perfect for Instagram Reels â€¢ 6 slides with animations â€¢ Add your background in CapCut
        </p>
    </div>

    <!-- Slides Processing Modal -->
    <div class="slides-modal" id="slidesModal">
        <div class="slides-modal-content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-spinner"></i> Generating Reel Slides
            </h2>
            <div class="slides-spinner"></div>
            <div class="slides-status" id="slidesStatus">Creating slide 1 of 6...</div>
            <div style="color: var(--gray); font-size: 14px; margin-top: 20px;">
                Downloading 6 slides for your Instagram Reel...
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // ========================
        // ORIGINAL CODE (UNCHANGED)
        // ========================
        
        // Check if user is admin
        function checkAdminAccess() {
            const savedUser = localStorage.getItem('decodexmarket_current_user');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                if (user.role === "admin") {
                    return true;
                }
            }
            return false;
        }

        // Data configuration
        const MARKET_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQgqBUGz6xFmT2Pd5qdvTZGYm3H3d-KgZlL65PHanPKDz3b9mp1rx7ZQNlV8BUJnYY0nfk-jyYvjWNY/pub?gid=658749771&single=true&output=csv";
        
        // Sample data fallback
        const sampleData = {
            date: "Thursday, 25 January 2024",
            prediction: "Market May Go Up",
            resistance: ["25128", "25208", "25288", "25367", "25447"],
            support: ["24800", "24720", "24640", "24560", "24480"],
            reversalBars: ["4", "8", "12", "13", "18"] // Number of 15-min bars
        };

        // DOM Elements
        const currentDateEl = document.getElementById('currentDate');
        const finalPredictionEl = document.getElementById('finalPrediction');
        const resistanceLevelsEl = document.getElementById('resistanceLevels');
        const supportLevelsEl = document.getElementById('supportLevels');
        const reversalTimesEl = document.getElementById('reversalTimes');

        // On page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is admin
            if (!checkAdminAccess()) {
                alert("Access Denied. This page is for admin users only.");
                window.location.href = 'index.html';
                return;
            }
            
            // If admin, proceed with initialization
            fetchData();
            setInterval(fetchData, 5 * 60 * 1000);
        });

        // Parse CSV
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            lines.forEach(line => {
                if (line.trim()) {
                    const row = [];
                    let inQuotes = false;
                    let currentValue = '';
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        const nextChar = line[i + 1];
                        
                        if (char === '"' && inQuotes && nextChar === '"') {
                            currentValue += '"';
                            i++;
                        } else if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(currentValue);
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    
                    row.push(currentValue);
                    rows.push(row);
                }
            });
            
            return rows;
        }

        // Fetch data from Google Sheets
        async function fetchData() {
            try {
                showLoading(true);
                
                const response = await fetch(MARKET_SHEET_URL);
                if (!response.ok) throw new Error('Network error');
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length > 0) {
                    updateOverview(rows);
                    showNotification('Data updated!', 'success');
                } else {
                    throw new Error("No data received");
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                updateWithSampleData();
                showNotification('Using sample data', 'warning');
            } finally {
                showLoading(false);
            }
        }

        // Update overview with actual data
        function updateOverview(rows) {
            // Date
            if (rows[2] && rows[2][0]) {
                const dateValue = rows[2][0];
                currentDateEl.textContent = dateValue;
            } else {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                currentDateEl.textContent = tomorrow.toLocaleDateString('en-IN', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            }
            
            // Prediction
            if (rows[0] && (rows[0][3] || rows[0][4])) {
                const prediction = (rows[0][3] || rows[0][4]).trim();
                finalPredictionEl.textContent = prediction;
                
                // Color based on prediction
                if (prediction.toLowerCase().includes('up') || prediction.toLowerCase().includes('bull')) {
                    finalPredictionEl.style.color = '#10b981';
                } else if (prediction.toLowerCase().includes('down') || prediction.toLowerCase().includes('bear')) {
                    finalPredictionEl.style.color = '#f43f5e';
                } else {
                    finalPredictionEl.style.color = '#f39c12';
                }
            }
            
            // Support & Resistance Levels (first 5 from rows 13-17)
            updateLevels(rows.slice(13, 18));
            
            // Reversal bars and times (from column D rows 7-11)
            updateReversalTimes(rows.slice(7, 12));
        }

        // Update Support & Resistance levels
        function updateLevels(levelRows) {
            resistanceLevelsEl.innerHTML = '';
            supportLevelsEl.innerHTML = '';
            
            // Get first 5 resistance levels (column B)
            for (let i = 0; i < 5; i++) {
                const row = levelRows[i];
                const value = row && row[1] ? row[1] : `R${i+1}`;
                
                const levelEl = document.createElement('div');
                levelEl.className = 'level-value resistance-value';
                levelEl.textContent = value;
                resistanceLevelsEl.appendChild(levelEl);
            }
            
            // Get first 5 support levels (column A)
            for (let i = 0; i < 5; i++) {
                const row = levelRows[i];
                const value = row && row[0] ? row[0] : `S${i+1}`;
                
                const levelEl = document.createElement('div');
                levelEl.className = 'level-value support-value';
                levelEl.textContent = value;
                supportLevelsEl.appendChild(levelEl);
            }
        }

        // Update reversal times (15-minute bars to time conversion)
        function updateReversalTimes(reversalRows) {
            reversalTimesEl.innerHTML = '';
            
            // Get reversal bars from column D (index 3)
            const bars = [];
            for (let i = 0; i < reversalRows.length; i++) {
                if (reversalRows[i] && reversalRows[i][3]) {
                    const bar = parseInt(reversalRows[i][3]);
                    if (!isNaN(bar) && bar > 0) {
                        bars.push(bar);
                    }
                }
            }
            
            // If no data, use sample
            if (bars.length === 0) {
                bars.push(...sampleData.reversalBars.map(Number));
            }
            
            // Sort ascending and take unique values
            const uniqueBars = [...new Set(bars)].sort((a, b) => a - b);
            
            // Take first 4 bars for display
            const displayBars = uniqueBars.slice(0, 4);
            
            // Calculate times (Market opens at 9:15 AM)
            const marketOpen = new Date();
            marketOpen.setHours(9, 15, 0, 0);
            
            // Create time items
            displayBars.forEach(bar => {
                const time = new Date(marketOpen.getTime() + (bar * 15 * 60 * 1000));
                const timeStr = time.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                }).toUpperCase();
                
                const timeItem = document.createElement('div');
                timeItem.className = 'time-item';
                timeItem.innerHTML = `
                    <div class="time-bar">${bar} Bars</div>
                    <div class="time-value">${timeStr}</div>
                `;
                reversalTimesEl.appendChild(timeItem);
            });
            
            // Fill remaining slots if needed
            for (let i = displayBars.length; i < 4; i++) {
                const timeItem = document.createElement('div');
                timeItem.className = 'time-item';
                timeItem.innerHTML = `
                    <div class="time-bar">--</div>
                    <div class="time-value">--:--</div>
                `;
                reversalTimesEl.appendChild(timeItem);
            }
        }

        // Fallback to sample data
        function updateWithSampleData() {
            currentDateEl.textContent = sampleData.date;
            finalPredictionEl.textContent = sampleData.prediction;
            finalPredictionEl.style.color = '#10b981';
            
            // Update levels
            resistanceLevelsEl.innerHTML = '';
            supportLevelsEl.innerHTML = '';
            
            sampleData.resistance.forEach(value => {
                const levelEl = document.createElement('div');
                levelEl.className = 'level-value resistance-value';
                levelEl.textContent = value;
                resistanceLevelsEl.appendChild(levelEl);
            });
            
            sampleData.support.forEach(value => {
                const levelEl = document.createElement('div');
                levelEl.className = 'level-value support-value';
                levelEl.textContent = value;
                supportLevelsEl.appendChild(levelEl);
            });
            
            // Update reversal times
            const marketOpen = new Date();
            marketOpen.setHours(9, 15, 0, 0);
            
            reversalTimesEl.innerHTML = '';
            sampleData.reversalBars.slice(0, 4).forEach(bar => {
                const time = new Date(marketOpen.getTime() + (bar * 15 * 60 * 1000));
                const timeStr = time.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                }).toUpperCase();
                
                const timeItem = document.createElement('div');
                timeItem.className = 'time-item';
                timeItem.innerHTML = `
                    <div class="time-bar">${bar} Bars</div>
                    <div class="time-value">${timeStr}</div>
                `;
                reversalTimesEl.appendChild(timeItem);
            });
        }

        // Refresh data manually
        function refreshData() {
            fetchData();
        }

        // Export as image
        function exportAsImage() {
            const box = document.getElementById('overviewBox');
            
            function captureImage() {
                showNotification('Creating image...', 'info');
                
                html2canvas(box, {
                    scale: 3, // High resolution
                    backgroundColor: '#0d1525',
                    useCORS: true,
                    logging: false,
                    width: box.offsetWidth,
                    height: box.offsetHeight
                }).then(canvas => {
                    // Create download link
                    const link = document.createElement('a');
                    const dateStr = new Date().toLocaleDateString('en-IN').replace(/\//g, '-');
                    link.download = `Market_Overview_${dateStr}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    showNotification('Image downloaded!', 'success');
                }).catch(error => {
                    console.error('Error:', error);
                    showNotification('Export failed. Try again.', 'error');
                });
            }
            
            if (typeof html2canvas === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = captureImage;
                document.head.appendChild(script);
                showNotification('Loading export tool...', 'info');
            } else {
                captureImage();
            }
        }

        // Show loading state
        function showLoading(show) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                if (show) {
                    section.classList.add('loading');
                } else {
                    section.classList.remove('loading');
                }
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#f43f5e' : 
                                          type === 'warning' ? '#f39c12' : 
                                          '#10b981';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ========================
        // NEW: REEL SLIDES GENERATOR
        // ========================
        
        async function generateReelSlides() {
            // Show processing modal
            const modal = document.getElementById('slidesModal');
            const status = document.getElementById('slidesStatus');
            modal.style.display = 'flex';
            
            // Get current data
            const prediction = finalPredictionEl.textContent;
            const dateStr = currentDateEl.textContent;
            const resLevels = Array.from(document.querySelectorAll('.resistance-value')).map(el => el.textContent).slice(0, 3);
            const supLevels = Array.from(document.querySelectorAll('.support-value')).map(el => el.textContent).slice(0, 3);
            const reversalItems = Array.from(document.querySelectorAll('.time-value')).map(el => el.textContent);
            const validReversalTimes = reversalItems.filter(t => t !== '--:--');
            
            try {
                // SLIDE 1: Question Slide
                status.textContent = 'Creating Slide 1: Hook Question...';
                await createSlide1(dateStr);
                
                // SLIDE 2: Expected Move
                status.textContent = 'Creating Slide 2: Expected Move...';
                await createSlide2(prediction);
                
                // SLIDE 3: Support & Resistance
                status.textContent = 'Creating Slide 3: Support & Resistance...';
                await createSlide3(supLevels, resLevels);
                
                // SLIDE 4: Reversal Timings
                status.textContent = 'Creating Slide 4: Reversal Timings...';
                await createSlide4(validReversalTimes);
                
                // SLIDE 5: Branding & Services
                status.textContent = 'Creating Slide 5: Branding & Services...';
                await createSlide5();
                
                // SLIDE 6: Disclaimer
                status.textContent = 'Creating Slide 6: Disclaimer...';
                await createSlide6();
                
                // Hide modal
                setTimeout(() => {
                    modal.style.display = 'none';
                    showNotification('6 slides downloaded! Add to CapCut with transitions.', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Slide generation error:', error);
                modal.style.display = 'none';
                showNotification('Slide generation failed. Try again.', 'error');
            }
        }

        // Create Slide 1: Hook Question
        async function createSlide1(dateStr) {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');
            
            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, 1080, 1920);
            gradient.addColorStop(0, '#0f172a');
            gradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            // Title
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('WANT TO KNOW', 540, 600);
            ctx.fillText('HOW NIFTY MOVES', 540, 720);
            ctx.fillText('TOMORROW?', 540, 840);
            
            // Date
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 40px Arial';
            ctx.fillText(dateStr, 540, 1000);
            
            // Question
            ctx.fillStyle = '#f43f5e';
            ctx.font = 'bold 60px Arial';
            ctx.fillText('UP OR DOWN?', 540, 1200);
            
            // DecodeX branding
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = 'bold 30px Arial';
            ctx.fillText('DecodeX Market Analysis', 540, 1500);
            
            // Download
            downloadCanvas(canvas, 'DecodeX_Slide1_Hook.png');
        }

        // Create Slide 2: Expected Move
        async function createSlide2(prediction) {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 1080, 1920);
            gradient.addColorStop(0, '#0f172a');
            gradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            // Title
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 70px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('EXPECTED MOVE', 540, 400);
            
            // Based on
            ctx.fillStyle = '#f59e0b';
            ctx.font = 'bold 35px Arial';
            ctx.fillText('Based on FII-DII DATA DECODING', 540, 500);
            
            // Prediction (color based on content)
            let predictionColor = '#10b981'; // Default green
            if (prediction.toLowerCase().includes('down') || prediction.toLowerCase().includes('bear')) {
                predictionColor = '#f43f5e'; // Red for bearish
            } else if (prediction.toLowerCase().includes('sideways') || prediction.toLowerCase().includes('consolidat')) {
                predictionColor = '#f59e0b'; // Yellow for sideways
            }
            
            ctx.fillStyle = predictionColor;
            ctx.font = 'bold 90px Arial';
            ctx.fillText(prediction.toUpperCase(), 540, 750);
            
            // Participants Wise Data Decoding
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 30px Arial';
            ctx.fillText('Participants Wise Data Decoding:', 540, 900);
            
            // Bullet points
            ctx.font = 'bold 35px Arial';
            ctx.textAlign = 'left';
            const bullets = ['CLIENT', 'DII', 'FII', 'PRO'];
            bullets.forEach((bullet, index) => {
                ctx.fillStyle = '#10b981';
                ctx.fillText('â€¢', 350, 1000 + (index * 80));
                ctx.fillStyle = 'white';
                ctx.fillText(bullet, 400, 1000 + (index * 80));
            });
            
            // Download
            downloadCanvas(canvas, 'DecodeX_Slide2_Prediction.png');
        }

        // Create Slide 3: Support & Resistance
        async function createSlide3(supLevels, resLevels) {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 1080, 1920);
            gradient.addColorStop(0, '#0f172a');
            gradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            // Title
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 70px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('NIFTY LEVELS FOR TOMORROW', 540, 300);
            
            // Resistance Section
            ctx.fillStyle = '#f43f5e';
            ctx.font = 'bold 50px Arial';
            ctx.fillText('RESISTANCE', 540, 450);
            
            // Resistance Levels
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            resLevels.forEach((level, index) => {
                ctx.fillStyle = '#ff6b8b';
                ctx.fillText(level, 540, 550 + (index * 100));
            });
            
            // Support Section
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 50px Arial';
            ctx.fillText('SUPPORT', 540, 1000);
            
            // Support Levels
            ctx.font = 'bold 60px Arial';
            supLevels.forEach((level, index) => {
                ctx.fillStyle = '#34d399';
                ctx.fillText(level, 540, 1100 + (index * 100));
            });
            
            // Note
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 30px Arial';
            ctx.fillText('Trade these levels with proper risk management', 540, 1650);
            
            // Download
            downloadCanvas(canvas, 'DecodeX_Slide3_Levels.png');
        }

        // Create Slide 4: Reversal Timings
        async function createSlide4(reversalTimes) {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 1080, 1920);
            gradient.addColorStop(0, '#0f172a');
            gradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            // Title
            ctx.fillStyle = '#f59e0b';
            ctx.font = 'bold 70px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('INTRADAY REVERSAL TIMINGS', 540, 350);
            
            // Subtitle
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 35px Arial';
            ctx.fillText('NIFTY (Expected Time)', 540, 450);
            
            // Clock icon
            ctx.fillStyle = '#f59e0b';
            ctx.font = 'bold 80px Arial';
            ctx.fillText('â°', 540, 600);
            
            // Reversal Times
            ctx.fillStyle = 'white';
            ctx.font = 'bold 70px Arial';
            reversalTimes.forEach((time, index) => {
                ctx.fillText(time, 540, 750 + (index * 120));
            });
            
            // Note
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 30px Arial';
            ctx.fillText('Based on 15-minute candle analysis', 540, 1300);
            ctx.fillText('Watch for price action at these times', 540, 1350);
            
            // Market hours
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 35px Arial';
            ctx.fillText('Market Hours: 9:15 AM - 3:30 PM', 540, 1500);
            
            // Download
            downloadCanvas(canvas, 'DecodeX_Slide4_Reversals.png');
        }

        // Create Slide 5: Branding & Services
        async function createSlide5() {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 1080, 1920);
            gradient.addColorStop(0, '#0f172a');
            gradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            // Logo area (simulated)
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 100px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('DecodeX', 540, 300);
            
            // Subtitle
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'italic bold 40px Arial';
            ctx.fillText('"Markets Are Random, Data Isn\'t"', 540, 420);
            
            // Markets
            ctx.fillStyle = '#f59e0b';
            ctx.font = 'bold 50px Arial';
            ctx.fillText('NIFTY â€¢ BANKNIFTY â€¢ SENSEX', 540, 550);
            
            // Services Title
            ctx.fillStyle = '#10b981';
            ctx.font = 'bold 45px Arial';
            ctx.fillText('Daily Market Decode ðŸ”', 540, 700);
            
            // Services List
            ctx.textAlign = 'left';
            const services = [
                'FIIâ€“DII | OI-Analysis',
                'Reversal Timings & Levels',
                'Visit Before Market Open'
            ];
            
            services.forEach((service, index) => {
                ctx.fillStyle = '#10b981';
                ctx.font = 'bold 40px Arial';
                ctx.fillText('â€¢', 350, 850 + (index * 100));
                ctx.fillStyle = 'white';
                ctx.fillText(service, 400, 850 + (index * 100));
            });
            
            // CTA
            ctx.textAlign = 'center';
            ctx.fillStyle = '#f43f5e';
            ctx.font = 'bold 45px Arial';
            ctx.fillText('SAVE THIS FOR TOMORROW\'S TRADING!', 540, 1250);
            
            // Follow
            ctx.fillStyle = '#E4405F';
            ctx.font = 'bold 40px Arial';
            ctx.fillText('Follow @DecodeXMarket', 540, 1350);
            ctx.fillText('for Daily Market Decode', 540, 1400);
            
            // WhatsApp
            ctx.fillStyle = '#4ADE80';
            ctx.font = 'bold 45px Arial';
            ctx.fillText('WhatsApp: 8271890090', 540, 1500);
            
            // Download
            downloadCanvas(canvas, 'DecodeX_Slide5_Branding.png');
        }

        // Create Slide 6: Disclaimer
        async function createSlide6() {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, 1080, 1920);
            gradient.addColorStop(0, '#0f172a');
            gradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 1080, 1920);
            
            // Warning icon
            ctx.fillStyle = '#f43f5e';
            ctx.font = 'bold 120px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('âš ï¸', 540, 300);
            
            // Title
            ctx.fillStyle = '#f43f5e';
            ctx.font = 'bold 70px Arial';
            ctx.fillText('IMPORTANT DISCLAIMER', 540, 500);
            
            // Disclaimer text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 35px Arial';
            ctx.textAlign = 'left';
            
            const disclaimerLines = [
                'I AM NOT SEBI REGISTERED.',
                '',
                'Any information provided by me or',
                'DecodeXMarket platform (website,',
                'social media, etc.) is based on',
                'my personal study of the market.',
                '',
                'This is NOT financial advice.',
                '',
                'DO NOT consider this as any',
                'buy/sell recommendation.',
                '',
                'Trade at your own risk.',
                'Always consult a registered advisor.'
            ];
            
            disclaimerLines.forEach((line, index) => {
                ctx.fillText(line, 100, 650 + (index * 60));
            });
            
            // Final note
            ctx.textAlign = 'center';
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 30px Arial';
            ctx.fillText('For educational purposes only', 540, 1650);
            
            // Download
            downloadCanvas(canvas, 'DecodeX_Slide6_Disclaimer.png');
        }

        // Helper function to download canvas as PNG
        function downloadCanvas(canvas, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
