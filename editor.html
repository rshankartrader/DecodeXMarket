<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DecodeXMarket - Tomorrow Market Overview</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== CSS RESET & VARIABLES ===== */
        :root {
            --primary: #10b981;
            --secondary: #059669;
            --accent: #f43f5e;
            --warning: #f59e0b;
            --dark: #0f172a;
            --darker: #0a1120;
            --light: #ecf0f1;
            --gray: #94a3b8;
            --border: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        /* ===== COMPACT 9:16 RECTANGLE BOX ===== */
        .rectangle-box {
            width: 337.5px;
            height: 600px;
            background: linear-gradient(145deg, #0d1525, #111a2d);
            border-radius: 18px;
            border: 3px solid var(--primary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        /* [Keep all your original rectangle box styles] */
        /* [They remain exactly the same] */

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
            flex-shrink: 0;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .control-btn.secondary {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        }

        .control-btn.slides {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .control-btn.download-all {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }

        /* Individual Slide Controls */
        .slide-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            max-width: 600px;
        }

        .slide-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .slide-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .slide-btn:nth-child(1) { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .slide-btn:nth-child(2) { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .slide-btn:nth-child(3) { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .slide-btn:nth-child(4) { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .slide-btn:nth-child(5) { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .slide-btn:nth-child(6) { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }

        /* Loading */
        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--primary);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-weight: 600;
            font-size: 13px;
            max-width: 300px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Slides Section */
        .slides-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid var(--border);
            width: 100%;
            max-width: 800px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 20px;
            font-weight: 700;
        }

        .slides-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .slide-preview {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .slide-preview:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.2);
        }

        .slide-number {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 14px;
        }

        .slide-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .slide-title {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 10px;
            color: white;
        }

        .slide-desc {
            font-size: 12px;
            color: var(--gray);
            line-height: 1.4;
        }

        /* Processing Modal */
        .processing-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .processing-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            border: 3px solid var(--primary);
            text-align: center;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 20px auto;
            animation: spin 1s linear infinite;
        }

        .processing-text {
            color: white;
            font-size: 18px;
            margin: 20px 0;
            font-weight: 600;
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 25px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .slides-grid {
                grid-template-columns: 1fr;
            }
            
            .slide-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .rectangle-box {
                width: 90vw;
                height: 160vw;
                padding: 15px;
            }
            
            .controls, .slide-controls {
                flex-direction: column;
                width: 90vw;
            }
            
            .control-btn, .slide-btn {
                width: 100%;
                justify-content: center;
            }
            
            .slide-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: var(--primary); text-align: center; margin-bottom: 5px; font-size: 20px;">
            <i class="fas fa-chart-line"></i> Market Overview & Reel Slides Generator
        </h1>
        <p style="color: var(--gray); text-align: center; margin-bottom: 15px; font-size: 12px;">
            9:16 Instagram Format ‚Ä¢ All Data in One View ‚Ä¢ 6 Professional Slides
        </p>

        <!-- 9:16 Rectangle Box -->
        <div class="rectangle-box" id="overviewBox">
            <!-- [Your existing rectangle box content remains exactly the same] -->
            <!-- Header -->
            <div class="box-header">
                <h1>Tomorrow Market Overview</h1>
                <div class="box-date" id="currentDate">Loading...</div>
            </div>

            <!-- Expected Move -->
            <div class="section prediction-box">
                <div class="section-title">
                    <i class="fas fa-bullhorn"></i> Expected Move
                </div>
                <div id="finalPrediction">Loading prediction...</div>
            </div>

            <!-- Support & Resistance -->
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-layer-group"></i> Support & Resistance
                </div>
                <div class="levels-section">
                    <!-- Resistance -->
                    <div class="levels-row">
                        <div class="level-label resistance-label">
                            <i class="fas fa-arrow-up"></i> R:
                        </div>
                        <div class="levels-container" id="resistanceLevels">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Support -->
                    <div class="levels-row">
                        <div class="level-label support-label">
                            <i class="fas fa-arrow-down"></i> S:
                        </div>
                        <div class="levels-container" id="supportLevels">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expected Reversal Times -->
            <div class="section reversal-section">
                <div class="section-title">
                    <i class="fas fa-retweet"></i> Expected Reversal @15min
                </div>
                <div class="reversal-times" id="reversalTimes">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <!-- Contact Information -->
            <div class="contact-info">
                <div class="contact-row">
                    <div class="contact-icon">
                        <i class="fab fa-instagram"></i>
                    </div>
                    <div class="contact-text instagram-text">
                        @DecodeXMarket
                    </div>
                </div>
                <div class="contact-row">
                    <div class="contact-icon">
                        <i class="fab fa-whatsapp"></i>
                    </div>
                    <div class="contact-text whatsapp-text">
                        WhatsApp: 8271890090
                    </div>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="disclaimer-box">
                <strong>Disclaimer:</strong> I am not SEBI registered, provided info is only for educational purposes and don't consider it as buy or sell signal.
            </div>
        </div>

        <!-- Main Controls -->
        <div class="controls">
            <button class="control-btn" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="control-btn" onclick="exportAsImage()">
                <i class="fas fa-download"></i> Export Image
            </button>
            <button class="control-btn download-all" onclick="downloadAllSlides()">
                <i class="fas fa-layer-group"></i> Download All 6 Slides
            </button>
            <button class="control-btn secondary" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i> Dashboard
            </button>
        </div>

        <!-- Slides Section -->
        <div class="slides-section">
            <div class="section-header">
                <i class="fas fa-images"></i>
                <span>Individual Reel Slides (Click to Download)</span>
            </div>
            
            <div class="slides-grid">
                <!-- Slide 1 -->
                <div class="slide-preview" onclick="downloadSlide(1)">
                    <div class="slide-number">1</div>
                    <div class="slide-icon">ü§î</div>
                    <div class="slide-title">Hook Question</div>
                    <div class="slide-desc">Want to know Nifty's move tomorrow?</div>
                </div>
                
                <!-- Slide 2 -->
                <div class="slide-preview" onclick="downloadSlide(2)">
                    <div class="slide-number">2</div>
                    <div class="slide-icon">üìà</div>
                    <div class="slide-title">Expected Move</div>
                    <div class="slide-desc">FII-DII Data Decoding Prediction</div>
                </div>
                
                <!-- Slide 3 -->
                <div class="slide-preview" onclick="downloadSlide(3)">
                    <div class="slide-number">3</div>
                    <div class="slide-icon">‚öñÔ∏è</div>
                    <div class="slide-title">Support & Resistance</div>
                    <div class="slide-desc">Key Nifty Levels for Tomorrow</div>
                </div>
                
                <!-- Slide 4 -->
                <div class="slide-preview" onclick="downloadSlide(4)">
                    <div class="slide-number">4</div>
                    <div class="slide-icon">‚è∞</div>
                    <div class="slide-title">Reversal Timings</div>
                    <div class="slide-desc">Intraday Reversal Points</div>
                </div>
                
                <!-- Slide 5 -->
                <div class="slide-preview" onclick="downloadSlide(5)">
                    <div class="slide-number">5</div>
                    <div class="slide-icon">üèÜ</div>
                    <div class="slide-title">Branding & CTA</div>
                    <div class="slide-desc">Services + WhatsApp + Follow</div>
                </div>
                
                <!-- Slide 6 -->
                <div class="slide-preview" onclick="downloadSlide(6)">
                    <div class="slide-number">6</div>
                    <div class="slide-icon">‚ö†Ô∏è</div>
                    <div class="slide-title">Disclaimer</div>
                    <div class="slide-desc">Legal & Risk Information</div>
                </div>
            </div>
            
            <!-- Individual Slide Controls -->
            <div class="slide-controls">
                <button class="slide-btn" onclick="downloadSlide(1)">
                    <i class="fas fa-download"></i> Slide 1
                </button>
                <button class="slide-btn" onclick="downloadSlide(2)">
                    <i class="fas fa-download"></i> Slide 2
                </button>
                <button class="slide-btn" onclick="downloadSlide(3)">
                    <i class="fas fa-download"></i> Slide 3
                </button>
                <button class="slide-btn" onclick="downloadSlide(4)">
                    <i class="fas fa-download"></i> Slide 4
                </button>
                <button class="slide-btn" onclick="downloadSlide(5)">
                    <i class="fas fa-download"></i> Slide 5
                </button>
                <button class="slide-btn" onclick="downloadSlide(6)">
                    <i class="fas fa-download"></i> Slide 6
                </button>
            </div>
        </div>

        <p style="color: var(--gray); text-align: center; margin-top: 20px; font-size: 11px;">
            <i class="fas fa-info-circle"></i> Professional 9:16 slides for Instagram Reels ‚Ä¢ Click any slide to download
        </p>
    </div>

    <!-- Processing Modal -->
    <div class="processing-modal" id="processingModal">
        <div class="processing-content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-spinner"></i> Generating Slides
            </h2>
            <div class="processing-spinner"></div>
            <div class="processing-text" id="processingText">Preparing slides...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div style="color: var(--gray); font-size: 14px; margin-top: 20px;">
                <span id="currentSlide">Slide 1 of 6</span>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // ========================
        // ORIGINAL DATA FUNCTIONS
        // ========================
        
        function checkAdminAccess() {
            const savedUser = localStorage.getItem('decodexmarket_current_user');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                return user.role === "admin";
            }
            return false;
        }

        const MARKET_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQgqBUGz6xFmT2Pd5qdvTZGYm3H3d-KgZlL65PHanPKDz3b9mp1rx7ZQNlV8BUJnYY0nfk-jyYvjWNY/pub?gid=658749771&single=true&output=csv";
        
        const sampleData = {
            date: new Date().toLocaleDateString('en-IN', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }),
            prediction: "Market May Go Up",
            resistance: ["25128", "25208", "25288"],
            support: ["24800", "24720", "24640"],
            reversalBars: ["4", "8", "12", "13"]
        };

        const currentDateEl = document.getElementById('currentDate');
        const finalPredictionEl = document.getElementById('finalPrediction');
        const resistanceLevelsEl = document.getElementById('resistanceLevels');
        const supportLevelsEl = document.getElementById('supportLevels');
        const reversalTimesEl = document.getElementById('reversalTimes');

        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAdminAccess()) {
                alert("Access Denied. This page is for admin users only.");
                window.location.href = 'index.html';
                return;
            }
            fetchData();
            setInterval(fetchData, 5 * 60 * 1000);
        });

        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            lines.forEach(line => {
                if (line.trim()) {
                    const row = [];
                    let inQuotes = false;
                    let currentValue = '';
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        const nextChar = line[i + 1];
                        
                        if (char === '"' && inQuotes && nextChar === '"') {
                            currentValue += '"';
                            i++;
                        } else if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(currentValue);
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    
                    row.push(currentValue);
                    rows.push(row);
                }
            });
            
            return rows;
        }

        async function fetchData() {
            try {
                showLoading(true);
                const response = await fetch(MARKET_SHEET_URL);
                if (!response.ok) throw new Error('Network error');
                
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                if (rows.length > 0) {
                    updateOverview(rows);
                    showNotification('Data updated!', 'success');
                } else {
                    throw new Error("No data received");
                }
            } catch (error) {
                console.error('Error:', error);
                updateWithSampleData();
                showNotification('Using sample data', 'warning');
            } finally {
                showLoading(false);
            }
        }

        function updateOverview(rows) {
            // Get tomorrow's date
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDate = tomorrow.toLocaleDateString('en-IN', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            currentDateEl.textContent = tomorrowDate;
            
            // Prediction
            if (rows[0] && (rows[0][3] || rows[0][4])) {
                const prediction = (rows[0][3] || rows[0][4]).trim();
                finalPredictionEl.textContent = prediction;
                
                if (prediction.toLowerCase().includes('up') || prediction.toLowerCase().includes('bull')) {
                    finalPredictionEl.style.color = '#10b981';
                } else if (prediction.toLowerCase().includes('down') || prediction.toLowerCase().includes('bear')) {
                    finalPredictionEl.style.color = '#f43f5e';
                } else {
                    finalPredictionEl.style.color = '#f59e0b';
                }
            }
            
            // Levels
            updateLevels(rows.slice(13, 18));
            updateReversalTimes(rows.slice(7, 12));
        }

        function updateLevels(levelRows) {
            resistanceLevelsEl.innerHTML = '';
            supportLevelsEl.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const row = levelRows[i];
                const resValue = row && row[1] ? row[1] : `R${i+1}`;
                const supValue = row && row[0] ? row[0] : `S${i+1}`;
                
                const resEl = document.createElement('div');
                resEl.className = 'level-value resistance-value';
                resEl.textContent = resValue;
                resistanceLevelsEl.appendChild(resEl);
                
                const supEl = document.createElement('div');
                supEl.className = 'level-value support-value';
                supEl.textContent = supValue;
                supportLevelsEl.appendChild(supEl);
            }
        }

        function updateReversalTimes(reversalRows) {
            reversalTimesEl.innerHTML = '';
            const bars = [];
            
            for (let i = 0; i < reversalRows.length; i++) {
                if (reversalRows[i] && reversalRows[i][3]) {
                    const bar = parseInt(reversalRows[i][3]);
                    if (!isNaN(bar) && bar > 0) bars.push(bar);
                }
            }
            
            if (bars.length === 0) bars.push(...sampleData.reversalBars.map(Number));
            
            const uniqueBars = [...new Set(bars)].sort((a, b) => a - b);
            const displayBars = uniqueBars.slice(0, 4);
            const marketOpen = new Date();
            marketOpen.setHours(9, 15, 0, 0);
            
            displayBars.forEach(bar => {
                const time = new Date(marketOpen.getTime() + (bar * 15 * 60 * 1000));
                const timeStr = time.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                }).toUpperCase();
                
                const timeItem = document.createElement('div');
                timeItem.className = 'time-item';
                timeItem.innerHTML = `
                    <div class="time-bar">${bar} Bars</div>
                    <div class="time-value">${timeStr}</div>
                `;
                reversalTimesEl.appendChild(timeItem);
            });
        }

        function updateWithSampleData() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            currentDateEl.textContent = tomorrow.toLocaleDateString('en-IN', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            finalPredictionEl.textContent = sampleData.prediction;
            finalPredictionEl.style.color = '#10b981';
            
            resistanceLevelsEl.innerHTML = '';
            supportLevelsEl.innerHTML = '';
            
            sampleData.resistance.forEach(value => {
                const el = document.createElement('div');
                el.className = 'level-value resistance-value';
                el.textContent = value;
                resistanceLevelsEl.appendChild(el);
            });
            
            sampleData.support.forEach(value => {
                const el = document.createElement('div');
                el.className = 'level-value support-value';
                el.textContent = value;
                supportLevelsEl.appendChild(el);
            });
            
            const marketOpen = new Date();
            marketOpen.setHours(9, 15, 0, 0);
            reversalTimesEl.innerHTML = '';
            
            sampleData.reversalBars.forEach(bar => {
                const time = new Date(marketOpen.getTime() + (bar * 15 * 60 * 1000));
                const timeStr = time.toLocaleTimeString('en-IN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                }).toUpperCase();
                
                const timeItem = document.createElement('div');
                timeItem.className = 'time-item';
                timeItem.innerHTML = `
                    <div class="time-bar">${bar} Bars</div>
                    <div class="time-value">${timeStr}</div>
                `;
                reversalTimesEl.appendChild(timeItem);
            });
        }

        function refreshData() {
            fetchData();
        }

        function exportAsImage() {
            const box = document.getElementById('overviewBox');
            
            function captureImage() {
                showNotification('Creating image...', 'info');
                
                html2canvas(box, {
                    scale: 3,
                    backgroundColor: '#0d1525',
                    useCORS: true,
                    logging: false,
                    width: box.offsetWidth,
                    height: box.offsetHeight
                }).then(canvas => {
                    const link = document.createElement('a');
                    const dateStr = new Date().toLocaleDateString('en-IN').replace(/\//g, '-');
                    link.download = `Market_Overview_${dateStr}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    showNotification('Image downloaded!', 'success');
                }).catch(error => {
                    console.error('Error:', error);
                    showNotification('Export failed. Try again.', 'error');
                });
            }
            
            if (typeof html2canvas === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                script.onload = captureImage;
                document.head.appendChild(script);
                showNotification('Loading export tool...', 'info');
            } else {
                captureImage();
            }
        }

        function showLoading(show) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                if (show) section.classList.add('loading');
                else section.classList.remove('loading');
            });
        }

        function showNotification(message, type = 'success') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? '#f43f5e' : 
                                          type === 'warning' ? '#f59e0b' : 
                                          '#10b981';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ========================
        // NEW: SLIDE GENERATION SYSTEM
        // ========================
        
        // Image assets
        const logoImg = new Image();
        logoImg.src = 'decodexlogo.png';
        
        const bgImg = new Image();
        bgImg.src = 'reelbg.png';
        
        // Store image loading status
        let assetsLoaded = false;
        let assetsLoading = false;
        
        // Load assets
        async function loadAssets() {
            if (assetsLoaded) return true;
            if (assetsLoading) {
                // Wait for loading to complete
                return new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (assetsLoaded) {
                            clearInterval(checkInterval);
                            resolve(true);
                        }
                    }, 100);
                });
            }
            
            assetsLoading = true;
            
            return new Promise((resolve) => {
                let loadedCount = 0;
                const totalAssets = 2;
                
                function assetLoaded() {
                    loadedCount++;
                    if (loadedCount === totalAssets) {
                        assetsLoaded = true;
                        assetsLoading = false;
                        resolve(true);
                    }
                }
                
                logoImg.onload = assetLoaded;
                logoImg.onerror = () => {
                    console.log('Logo image not found, will use text fallback');
                    assetLoaded();
                };
                
                bgImg.onload = assetLoaded;
                bgImg.onerror = () => {
                    console.log('Background image not found, will use gradient fallback');
                    assetLoaded();
                };
                
                // Timeout fallback
                setTimeout(() => {
                    if (!assetsLoaded) {
                        assetsLoaded = true;
                        assetsLoading = false;
                        resolve(true);
                    }
                }, 2000);
            });
        }

        // Get tomorrow's date for slides
        function getTomorrowDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toLocaleDateString('en-IN', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Get tomorrow's date in DD-MMM-YYYY format
        function getTomorrowDateFormatted() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).toUpperCase();
        }

        // Create a canvas for slide
        function createCanvas() {
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            return canvas;
        }

        // Draw background
        function drawBackground(ctx) {
            ctx.clearRect(0, 0, 1080, 1920);
            
            if (bgImg.complete && bgImg.naturalWidth > 0) {
                // Draw background image
                ctx.drawImage(bgImg, 0, 0, 1080, 1920);
                // Add dark overlay for readability
                ctx.fillStyle = 'rgba(15, 23, 42, 0.7)';
                ctx.fillRect(0, 0, 1080, 1920);
            } else {
                // Gradient fallback
                const gradient = ctx.createLinearGradient(0, 0, 1080, 1920);
                gradient.addColorStop(0, '#0f172a');
                gradient.addColorStop(1, '#1e293b');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1080, 1920);
                
                // Add subtle pattern
                ctx.fillStyle = 'rgba(255, 255, 255, 0.02)';
                for (let i = 0; i < 1080; i += 40) {
                    for (let j = 0; j < 1920; j += 40) {
                        if ((i + j) % 80 === 0) {
                            ctx.fillRect(i, j, 2, 2);
                        }
                    }
                }
            }
        }

        // Draw logo at top center
        function drawLogo(ctx) {
            if (logoImg.complete && logoImg.naturalWidth > 0) {
                // Calculate logo dimensions (max 200px width)
                const logoWidth = Math.min(logoImg.width, 200);
                const logoHeight = (logoImg.height / logoImg.width) * logoWidth;
                ctx.drawImage(logoImg, 540 - logoWidth/2, 80, logoWidth, logoHeight);
            } else {
                // Text fallback for logo
                ctx.fillStyle = '#10b981';
                ctx.font = 'bold 60px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('DecodeX', 540, 120);
                
                ctx.fillStyle = '#94a3b8';
                ctx.font = 'bold 20px Arial';
                ctx.fillText('MARKET ANALYSIS', 540, 170);
            }
        }

        // Draw text with effects
        function drawText(ctx, text, x, y, size, color, bold = true, shadow = true) {
            ctx.font = `${bold ? 'bold ' : ''}${size}px 'Segoe UI', Arial, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            if (shadow) {
                ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 3;
            }
            
            ctx.fillStyle = color;
            ctx.fillText(text, x, y);
            
            // Reset shadow
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
        }

        // Create rounded rectangle
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // Slide 1: Hook Question
        async function createSlide1() {
            await loadAssets();
            const canvas = createCanvas();
            const ctx = canvas.getContext('2d');
            
            drawBackground(ctx);
            drawLogo(ctx);
            
            // Tomorrow's date
            const tomorrowDate = getTomorrowDateFormatted();
            
            // Animated question marks background
            ctx.fillStyle = 'rgba(245, 158, 11, 0.1)';
            ctx.font = 'bold 300px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ü§î', 540, 500);
            ctx.fillText('ü§î', 200, 800);
            ctx.fillText('ü§î', 880, 1200);
            
            // Main question with glow
            ctx.shadowColor = 'rgba(245, 158, 11, 0.5)';
            ctx.shadowBlur = 30;
            drawText(ctx, "WANT TO KNOW", 540, 700, 65, '#ffffff', true, false);
            drawText(ctx, "HOW NIFTY MOVES", 540, 800, 65, '#f59e0b', true, false);
            
            // Tomorrow date with special styling
            ctx.fillStyle = 'rgba(16, 185, 129, 0.2)';
            roundRect(ctx, 340, 900, 400, 100, 25);
            ctx.fill();
            
            ctx.shadowColor = 'transparent';
            drawText(ctx, `TOMORROW ${tomorrowDate}`, 540, 950, 45, '#10b981', true);
            
            // UP/DOWN arrows with animation effect
            ctx.fillStyle = 'rgba(16, 185, 129, 0.15)';
            roundRect(ctx, 240, 1050, 250, 150, 30);
            ctx.fill();
            
            ctx.fillStyle = 'rgba(244, 63, 94, 0.15)';
            roundRect(ctx, 590, 1050, 250, 150, 30);
            ctx.fill();
            
            // UP button
            drawText(ctx, "üöÄ", 365, 1120, 70, '#10b981', true);
            drawText(ctx, "UP", 365, 1200, 50, '#10b981', true);
            
            // DOWN button
            drawText(ctx, "üìâ", 715, 1120, 70, '#f43f5e', true);
            drawText(ctx, "DOWN", 715, 1200, 50, '#f43f5e', true);
            
            // Connecting line with dots
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(490, 1125);
            ctx.lineTo(590, 1125);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Pulse animation dots
            ctx.fillStyle = '#f59e0b';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(540 + (i * 20), 1125, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Bottom text
            drawText(ctx, "Swipe for tomorrow's trading plan ‚Üí", 540, 1500, 30, '#94a3b8', false);
            drawText(ctx, "Based on FII-DII Data Analysis", 540, 1550, 25, '#94a3b8', false);
            
            return canvas;
        }

        // Slide 2: Expected Move
        async function createSlide2() {
            await loadAssets();
            const canvas = createCanvas();
            const ctx = canvas.getContext('2d');
            
            drawBackground(ctx);
            drawLogo(ctx);
            
            // Title
            drawText(ctx, "EXPECTED MOVE", 540, 300, 75, '#10b981', true);
            
            // Underline
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(340, 350);
            ctx.lineTo(740, 350);
            ctx.stroke();
            
            // Data source
            drawText(ctx, "Based on FII-DII Data Decoding", 540, 450, 35, '#f59e0b', true);
            
            // Prediction box
            const prediction = finalPredictionEl.textContent;
            const predictionColor = finalPredictionEl.style.color || '#10b981';
            
            // Glowing effect for prediction
            ctx.shadowColor = predictionColor;
            ctx.shadowBlur = 30;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            roundRect(ctx, 240, 550, 600, 180, 40);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Prediction text
            ctx.fillStyle = predictionColor;
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(prediction.toUpperCase(), 540, 640);
            
            // Participants section
            drawText(ctx, "PARTICIPANTS WISE ANALYSIS", 540, 800, 40, '#ffffff', true);
            
            // Participants grid
            const participants = [
                {name: 'CLIENT', emoji: 'üë§'},
                {name: 'DII', emoji: 'üè¶'},
                {name: 'FII', emoji: 'üåç'},
                {name: 'PRO', emoji: 'üëë'}
            ];
            
            participants.forEach((p, i) => {
                const x = 270 + (i % 2) * 540;
                const y = 900 + Math.floor(i / 2) * 200;
                
                // Participant card
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                roundRect(ctx, x - 100, y - 70, 200, 140, 20);
                ctx.fill();
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 2;
                roundRect(ctx, x - 100, y - 70, 200, 140, 20);
                ctx.stroke();
                
                // Emoji
                ctx.font = 'bold 50px Arial';
                ctx.fillStyle = '#10b981';
                ctx.fillText(p.emoji, x, y - 20);
                
                // Name
                drawText(ctx, p.name, x, y + 40, 35, '#ffffff', true);
            });
            
            // Data timestamp
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            }).toUpperCase();
            
            drawText(ctx, `Data updated: ${timeStr}`, 540, 1350, 25, '#94a3b8', false);
            
            return canvas;
        }

        // Slide 3: Support & Resistance
        async function createSlide3() {
            await loadAssets();
            const canvas = createCanvas();
            const ctx = canvas.getContext('2d');
            
            drawBackground(ctx);
            drawLogo(ctx);
            
            // Title
            drawText(ctx, "NIFTY LEVELS FOR TOMORROW", 540, 300, 60, '#ffffff', true);
            
            // Get levels
            const resElements = document.querySelectorAll('.resistance-value');
            const supElements = document.querySelectorAll('.support-value');
            const resLevels = Array.from(resElements).slice(0, 3).map(el => el.textContent);
            const supLevels = Array.from(supElements).slice(0, 3).map(el => el.textContent);
            
            // Resistance section
            ctx.fillStyle = 'rgba(244, 63, 94, 0.1)';
            roundRect(ctx, 100, 450, 400, 500, 30);
            ctx.fill();
            
            drawText(ctx, "RESISTANCE", 300, 520, 55, '#f43f5e', true);
            drawText(ctx, "üîª SELL ZONES", 300, 580, 30, '#ff6b8b', false);
            
            // Resistance levels with chart bars
            resLevels.forEach((level, i) => {
                const y = 680 + (i * 120);
                
                // Chart bar
                const barWidth = 200 + (i * 40);
                ctx.fillStyle = 'rgba(244, 63, 94, 0.3)';
                ctx.fillRect(200 - barWidth/2, y - 25, barWidth, 50);
                
                // Level text
                drawText(ctx, level, 300, y, 55, '#ffffff', true);
                
                // Up arrow
                ctx.fillStyle = '#f43f5e';
                ctx.font = 'bold 40px Arial';
                ctx.fillText('‚Üë', 380, y - 5);
            });
            
            // Support section
            ctx.fillStyle = 'rgba(16, 185, 129, 0.1)';
            roundRect(ctx, 580, 450, 400, 500, 30);
            ctx.fill();
            
            drawText(ctx, "SUPPORT", 780, 520, 55, '#10b981', true);
            drawText(ctx, "üü¢ BUY ZONES", 780, 580, 30, '#34d399', false);
            
            // Support levels with chart bars
            supLevels.forEach((level, i) => {
                const y = 680 + (i * 120);
                
                // Chart bar (inverse direction)
                const barWidth = 200 + ((2 - i) * 40);
                ctx.fillStyle = 'rgba(16, 185, 129, 0.3)';
                ctx.fillRect(780 - barWidth/2, y - 25, barWidth, 50);
                
                // Level text
                drawText(ctx, level, 780, y, 55, '#ffffff', true);
                
                // Down arrow
                ctx.fillStyle = '#10b981';
                ctx.font = 'bold 40px Arial';
                ctx.fillText('‚Üì', 860, y + 5);
            });
            
            // Trading tip
            ctx.fillStyle = 'rgba(245, 158, 11, 0.15)';
            roundRect(ctx, 140, 1000, 800, 120, 25);
            ctx.fill();
            
            drawText(ctx, "üí° TRADING STRATEGY", 540, 1040, 35, '#f59e0b', true);
            drawText(ctx, "Buy near support | Sell near resistance | Always use stop-loss", 540, 1090, 28, '#ffffff', false);
            
            return canvas;
        }

        // Slide 4: Reversal Timings
        async function createSlide4() {
            await loadAssets();
            const canvas = createCanvas();
            const ctx = canvas.getContext('2d');
            
            drawBackground(ctx);
            drawLogo(ctx);
            
            // Title with clock
            ctx.font = 'bold 100px Arial';
            ctx.fillStyle = '#f59e0b';
            ctx.textAlign = 'center';
            ctx.fillText('‚è∞', 540, 300);
            
            drawText(ctx, "INTRADAY REVERSAL TIMINGS", 540, 420, 60, '#ffffff', true);
            drawText(ctx, "NIFTY (15-Min Chart)", 540, 490, 40, '#f59e0b', true);
            
            // Get reversal times
            const timeElements = document.querySelectorAll('.time-value');
            const reversalTimes = Array.from(timeElements).map(el => el.textContent).filter(t => t !== '--:--');
            
            // Timeline visualization
            const startY = 650;
            const spacing = 180;
            
            reversalTimes.forEach((time, i) => {
                const y = startY + (i * spacing);
                
                // Clock circle
                ctx.fillStyle = i % 2 === 0 ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)';
                ctx.beginPath();
                ctx.arc(540, y, 80, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.strokeStyle = i % 2 === 0 ? '#10b981' : '#f59e0b';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(540, y, 80, 0, Math.PI * 2);
                ctx.stroke();
                
                // Clock hands (simulated)
                ctx.strokeStyle = i % 2 === 0 ? '#10b981' : '#f59e0b';
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(540, y);
                ctx.lineTo(540 + 50, y - 30);
                ctx.stroke();
                
                // Time text
                drawText(ctx, time, 540, y, 65, '#ffffff', true);
                
                // Point label
                drawText(ctx, `Reversal Point ${i + 1}`, 540, y + 100, 30, i % 2 === 0 ? '#94a3b8' : '#94a3b8', false);
                
                // Connect dots
                if (i < reversalTimes.length - 1) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(540, y + 80);
                    ctx.lineTo(540, y + spacing - 80);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            });
            
            // Market hours info
            ctx.fillStyle = 'rgba(148, 163, 184, 0.1)';
            roundRect(ctx, 240, 1350, 600, 100, 25);
            ctx.fill();
            
            drawText(ctx, "Market Hours: 9:15 AM - 3:30 PM", 540, 1400, 35, '#94a3b8', true);
            
            // Note
            drawText(ctx, "Watch for price action confirmation at these times", 540, 1500, 25, '#ffffff', false);
            drawText(ctx, "Based on historical pattern analysis", 540, 1540, 25, '#94a3b8', false);
            
            return canvas;
        }

        // Slide 5: Branding & CTA
        async function createSlide5() {
            await loadAssets();
            const canvas = createCanvas();
            const ctx = canvas.getContext('2d');
            
            drawBackground(ctx);
            drawLogo(ctx);
            
            // Tagline
            drawText(ctx, '"Markets Are Random,', 540, 350, 50, '#f59e0b', true);
            drawText(ctx, 'Data Isn\'t"', 540, 420, 50, '#10b981', true);
            
            // Markets covered
            drawText(ctx, "NIFTY ‚Ä¢ BANKNIFTY ‚Ä¢ SENSEX", 540, 520, 55, '#ffffff', true);
            
            // Services title
            drawText(ctx, "DAILY MARKET DECODE üîç", 540, 620, 45, '#10b981', true);
            
            // Services with icons
            const services = [
                {icon: 'üìä', text: 'FII‚ÄìDII | OI-Analysis'},
                {icon: '‚è∞', text: 'Reversal Timings & Levels'},
                {icon: 'üß†', text: 'Pattern Recognition'},
                {icon: 'üåÖ', text: 'Visit Before Market Open'}
            ];
            
            services.forEach((service, i) => {
                const y = 720 + (i * 120);
                ctx.font = 'bold 50px Arial';
                ctx.fillStyle = '#10b981';
                ctx.fillText(service.icon, 350, y);
                
                ctx.font = 'bold 35px Arial';
                ctx.fillStyle = '#ffffff';
                ctx.fillText(service.text, 450, y);
            });
            
            // CTA Box with glow
            ctx.shadowColor = '#f43f5e';
            ctx.shadowBlur = 30;
            ctx.fillStyle = 'rgba(244, 63, 94, 0.2)';
            roundRect(ctx, 140, 1250, 800, 150, 40);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.strokeStyle = '#f43f5e';
            ctx.lineWidth = 4;
            roundRect(ctx, 140, 1250, 800, 150, 40);
            ctx.stroke();
            
            drawText(ctx, "üíæ SAVE THIS FOR TOMORROW'S TRADING!", 540, 1320, 40, '#f43f5e', true);
            
            // Follow section
            drawText(ctx, "üì± WhatsApp: 8271890090", 540, 1450, 45, '#4ADE80', true);
            drawText(ctx, "üì∏ Follow @DecodeXMarket", 540, 1510, 40, '#E4405F', true);
            
            // Final note
            drawText(ctx, "Tomorrow's analysis ready before market opens", 540, 1650, 30, '#94a3b8', false);
            drawText(ctx, "Share with fellow traders!", 540, 1700, 30, '#f59e0b', true);
            
            return canvas;
        }

        // Slide 6: Disclaimer
        async function createSlide6() {
            await loadAssets();
            const canvas = createCanvas();
            const ctx = canvas.getContext('2d');
            
            drawBackground(ctx);
            drawLogo(ctx);
            
            // Warning symbol
            ctx.font = 'bold 120px Arial';
            ctx.fillStyle = '#f43f5e';
            ctx.textAlign = 'center';
            ctx.fillText('‚ö†Ô∏è', 540, 300);
            
            // Title
            drawText(ctx, "IMPORTANT DISCLAIMER", 540, 450, 70, '#f43f5e', true);
            
            // Disclaimer box
            ctx.fillStyle = 'rgba(244, 63, 94, 0.1)';
            roundRect(ctx, 90, 550, 900, 1000, 40);
            ctx.fill();
            
            ctx.strokeStyle = '#f43f5e';
            ctx.lineWidth = 4;
            roundRect(ctx, 90, 550, 900, 1000, 40);
            ctx.stroke();
            
            // Disclaimer text
            const lines = [
                "‚ö†Ô∏è I AM NOT SEBI REGISTERED",
                "",
                "This is NOT financial advice.",
                "",
                "Information provided is based on",
                "personal market study and analysis.",
                "",
                "DO NOT consider as buy/sell",
                "recommendations.",
                "",
                "‚ö†Ô∏è TRADE AT YOUR OWN RISK",
                "",
                "Always consult SEBI registered",
                "financial advisor before trading.",
                "",
                "Past performance ‚â† Future results",
                "",
                "For educational purposes only."
            ];
            
            lines.forEach((line, i) => {
                const y = 620 + (i * 60);
                const size = line.includes('‚ö†Ô∏è') ? 32 : 28;
                const color = line.includes('‚ö†Ô∏è') ? '#f43f5e' : '#ffffff';
                const bold = line.includes('‚ö†Ô∏è');
                
                drawText(ctx, line, 540, y, size, color, bold);
            });
            
            // Contact info
            drawText(ctx, "For queries: WhatsApp 8271890090", 540, 1650, 30, '#94a3b8', false);
            drawText(ctx, "Visit: DecodeXMarket Platform", 540, 1700, 30, '#10b981', false);
            
            return canvas;
        }

        // Download individual slide
        async function downloadSlide(slideNumber) {
            showNotification(`Creating Slide ${slideNumber}...`, 'info');
            
            let canvas;
            switch(slideNumber) {
                case 1: canvas = await createSlide1(); break;
                case 2: canvas = await createSlide2(); break;
                case 3: canvas = await createSlide3(); break;
                case 4: canvas = await createSlide4(); break;
                case 5: canvas = await createSlide5(); break;
                case 6: canvas = await createSlide6(); break;
                default: return;
            }
            
            // Download the slide
            const link = document.createElement('a');
            const dateStr = getTomorrowDateFormatted().replace(/ /g, '_');
            link.download = `DecodeX_Slide${slideNumber}_${dateStr}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Slide ${slideNumber} downloaded!`, 'success');
        }

        // Download all slides
        async function downloadAllSlides() {
            const modal = document.getElementById('processingModal');
            const progressBar = document.getElementById('progressBar');
            const processingText = document.getElementById('processingText');
            const currentSlide = document.getElementById('currentSlide');
            
            modal.style.display = 'flex';
            
            try {
                const slides = [];
                
                for (let i = 1; i <= 6; i++) {
                    // Update progress
                    const progress = Math.round((i / 6) * 100);
                    progressBar.style.width = `${progress}%`;
                    processingText.textContent = `Creating Slide ${i} of 6...`;
                    currentSlide.textContent = `Slide ${i} of 6`;
                    
                    let canvas;
                    switch(i) {
                        case 1: canvas = await createSlide1(); break;
                        case 2: canvas = await createSlide2(); break;
                        case 3: canvas = await createSlide3(); break;
                        case 4: canvas = await createSlide4(); break;
                        case 5: canvas = await createSlide5(); break;
                        case 6: canvas = await createSlide6(); break;
                    }
                    
                    slides.push({
                        canvas: canvas,
                        number: i,
                        date: getTomorrowDateFormatted()
                    });
                    
                    // Small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // Create zip file with all slides
                processingText.textContent = 'Creating download package...';
                
                // Download each slide individually (browser limitation)
                for (let i = 0; i < slides.length; i++) {
                    const slide = slides[i];
                    const link = document.createElement('a');
                    link.download = `DecodeX_Slide${slide.number}_${slide.date.replace(/ /g, '_')}.png`;
                    link.href = slide.canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    
                    // Trigger download with delay
                    setTimeout(() => {
                        link.click();
                        document.body.removeChild(link);
                    }, i * 500);
                }
                
                // Complete
                setTimeout(() => {
                    modal.style.display = 'none';
                    progressBar.style.width = '0%';
                    showNotification('All 6 slides downloaded! Ready for CapCut.', 'success');
                }, 3500);
                
            } catch (error) {
                console.error('Error generating slides:', error);
                modal.style.display = 'none';
                showNotification('Error generating slides. Please try individual downloads.', 'error');
            }
        }
    </script>
</body>
</html>
